<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emploi du Temps - UT2J</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet'>
    <link href="/styles/seance2.css" rel='stylesheet'>
    <link href="/styles/style.css" rel='stylesheet'>
    <!--    <script src="/scripts/profil.js" defer/>-->
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #004d99;
        }

        /* Styles de base */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header et Navigation */
        .navbar {
            background-color: var(--primary-color);
            padding: 1rem;
        }

        .navbar-brand {
            color: white !important;
        }

        /* Conteneur principal */
        .content-wrapper {
            flex: 1;
            padding: 1rem;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Panneau latéral */
        .sidebar {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Calendrier */
        #calendar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Formulaires et contrôles */
        .form-control, .form-select {
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .fc-header-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .fc-view-harness {
                height: auto !important;
                min-height: 500px;
            }

            .sidebar {
                margin-bottom: 1rem;
            }

            .filters-container .row {
                margin-bottom: 1rem;
            }
        }

        @media (min-width: 769px) {
            .content-wrapper {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .sidebar {
                position: sticky;
                top: 1rem;
                height: calc(100vh - 2rem);
                overflow-y: auto;
            }
        }

        /* Styles pour les modals */
        .modal-content {
            border-radius: 12px;
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        /* Styles pour les boutons */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* Styles d'impression */
        @media print {
            .navbar,
            .sidebar,
            .filters-container,
            .modal,
            .btn:not(.print-content),
            #printButton {
                display: none !important;
            }

            .content-wrapper {
                display: block;
                padding: 0;
            }

            #calendar {
                box-shadow: none;
                width: 100% !important;
                height: 100vh !important;
            }

            .print-content {
                display: block !important;
            }

            @page {
                size: landscape;
                margin: 2cm;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Styles pour les notifications */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Styles pour le formulaire de temps */
        .time-input-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .time-input-container input[type="time"] {
            padding-right: 2rem;
        }

        .time-validation-message {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            color: #dc3545;
        }

        /* Styles pour les tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: black;
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <img src="/images/logo.jpg"
                 alt="Logo UT2J">
            Teach Planner
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/seances">
                        <i class="fas fa-calendar-alt"></i>Calendrier
                    </a>
                </li>
                <li class="nav-item" th:classappend="${session.isAdmin ? 'd-none' : ''}">
                    <a class="nav-link" href="/disponnibilite" id="voirdispos">
                        <i class="fas fa-clock"></i>Disponibilités
                    </a>
                </li>
                <li class="nav-item" th:if="${session.isAdmin}">
                    <a class="nav-link" href="/personnels/liste">
                        <i class="fas fa-users"></i>Personnels
                    </a>
                </li>
                <li class="nav-item" th:if="${session.isAdmin}">
                    <a class="nav-link" href="/salles">
                        <i class="fas fa-door-open"></i>Salles
                    </a>
                </li>
                <li class="nav-item" th:if="${session.isAdmin}">
                    <a class="nav-link" href="/matieres/view">
                        <i class="fas fa-book"></i>Matières
                    </a>
                </li>
                <!-- Ajout du bouton de gestion des groupes dans la navbar pour les admins -->
                <li class="nav-item" th:if="${session.isAdmin}">
                    <a class="nav-link" href="/api/groupes">
                        <i class="fas fa-users-cog"></i>Groupes
                    </a>
                </li>
            </ul>

            <div class="d-flex align-items-center">
                <button id="printButton" class="btn btn-primary position-fixed"
                        style="bottom: 20px; right: 20px; z-index: 1000; border-radius: 50px; padding: 15px 25px;">
                    <i class="fas fa-print me-2"></i>
                    Imprimer l'emploi du temps
                </button>

                <style>
                    @media print {
                        .navbar,
                        .filters-container,
                        .modal,
                        .btn,
                        #printButton {
                            display: none !important;
                        }

                        .fc-header-toolbar {
                            display: none !important;
                        }

                        .fc-view-harness {
                            height: 100vh !important;
                        }

                        body {
                            padding: 0 !important;
                            margin: 0 !important;
                        }

                        #calendar {
                            width: 100% !important;
                            height: 100vh !important;
                        }

                        .print-header {
                            text-align: center;
                            margin-bottom: 20px;
                        }

                        .print-footer {
                            text-align: center;
                            margin-top: 20px;
                            font-size: 12px;
                            color: #666;
                            position: fixed;
                            bottom: 0;
                            width: 100%;
                        }

                        @page {
                            size: landscape;
                            margin: 2cm;
                        }
                    }
                </style>
                <div class="action-buttons">
                    <th:block th:switch="${session.role}">
                        <a th:case="'ETUDIANT'" href="/export/pdf/etudiant" class="btn btn-action btn-export" target="_blank">
                            <i class="fas fa-file-pdf"></i>Exporter en PDF
                        </a>
                        <a th:case="'ENSEIGNANT'" th:href="@{/export/pdf/enseignant/{id}(id=${session.userId})}" class="btn btn-action btn-export" target="_blank">
                            <i class="fas fa-file-pdf"></i>Exporter en PDF
                        </a>
                        <a th:case="'ADMIN'" href="/export/pdf" class="btn btn-action btn-export" target="_blank">
                            <i class="fas fa-file-pdf"></i>Exporter en PDF
                        </a>
                    </th:block>
                    <div class="position-relative me-3">-->
                        <button class="btn btn-icon btn-transparent" id="notificationButton">
                            <i class="fas fa-bell text-white"></i>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </button>
                    </div>
                    <!-- Section du profil améliorée -->
                    <div class="user-profile" id="profileTrigger">
                        <div class="user-avatar">
                            <span th:text="${#strings.substring(session.userEmail,0,1).toUpperCase()}">U</span>
                        </div>
                        <div class="user-info-container">
                            <p class="user-name" th:text="${session.nom + ' ' + session.prenom}">Nom Prénom</p>
                            <p class="user-role" th:text="${session.isAdmin ? 'Administrateur' : 'Enseignant'}">Rôle</p>
                        </div>
                    </div>

                    <!-- Nouveau menu déroulant du profil -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <span th:text="${#strings.substring(session.userEmail,0,1).toUpperCase()}">U</span>
                            </div>
                            <h4 class="profile-name" th:text="${session.nom + ' ' + session.prenom}">Nom Prénom</h4>
                            <p class="profile-role">
                                <!--                                <span th:text="${session.isAdmin ? 'Administrateur' : 'Enseignant'}">Rôle</span>-->
                                <span class="status-badge online">
                    <i class="fas fa-circle fa-xs"></i> En ligne
                </span>
                            </p>
                        </div>


                        <div class="profile-info">
                            <div class="profile-info-item">
                                <div class="profile-info-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div class="profile-info-content">
                                    <p class="profile-info-label">Email</p>
                                    <p class="profile-info-value" th:text="${session.userEmail}">email@example.com</p>
                                </div>
                            </div>



                            <div class="profile-info-item">
                                <div class="profile-info-icon">
                                    <i class="fas fa-user-tag"></i>
                                </div>
                                <div class="profile-info-content">
                                    <p class="profile-info-label">Statut</p>
                                    <span th:text="${session.isAdmin ? 'Administrateur' : 'Enseignant'}">Rôle</span>
                                    <!--                                    <p class="profile-info-value" th:text="${session.statut}">Statut</p>-->
                                </div>
                            </div>

                            <!--                            <div class="profile-info-item">-->
                            <!--                                <div class="profile-info-icon">-->
                            <!--                                    <i class="fas fa-calendar-check"></i>-->
                            <!--                                </div>-->
                            <!--                                <div class="profile-info-content">-->
                            <!--                                    <p class="profile-info-label">Date d'entrée</p>-->
                            <!--                                    <p class="profile-info-value" th:text="${#temporals.format(session.dateEntree, 'dd MMMM yyyy')}">-->
                            <!--                                        Date d'entrée-->
                            <!--                                    </p>-->
                            <!--                                </div>-->
                            <!--                            </div>-->
                        </div>
                        <div>
                            <a href="/password/modify" class="btn btn-action"> <i class="fas fa-pencil-alt"></i>Modifier mot de pass</a>

                            <a href="/logout" class="btn btn-action"><i class="fas fa-sign-out-alt"></i>Déconnexion</a>
                        </div>


                        <!--                        <div class="profile-footer">-->
                        <!--                            <button class="profile-action-btn btn-theme" id="themeToggle">-->
                        <!--                                <i class="fas fa-moon"></i>-->
                        <!--                                Thème sombre-->
                        <!--                            </button>-->
                        <!--                            <a href="/administrateurs/logout" class="profile-action-btn btn-logout" color="blue">-->
                        <!--                                <i class="fas fa-sign-out-alt"></i>-->
                        <!--                                Déconnexion-->
                        <!--                            </a>-->
                        <!--                        </div>-->

                        <!--                        <div class="last-login">-->
                        <!--                            Dernière connexion: <span th:text="${#temporals.format(session.lastLogin, 'dd/MM/yyyy HH:mm')}">01/01/2024 12:00</span>-->
                        <!--                        </div>-->
                    </div>
                </div>

                <!-- Ajout du système de notifications -->
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <i class="fas fa-bell me-2"></i>
                        Notifications
                    </div>
                    <div class="notification-list">
                        <!-- Les notifications seront ajoutées dynamiquement ici -->
                    </div>
                </div>

                <!-- Modification de la section user-profile pour ajouter le bouton de notifications -->
                <!--                    <div class="user-profile">-->
                <!--                        <div class="position-relative me-3">-->
                <!--                            <button class="btn btn-icon btn-transparent" id="notificationButton">-->
                <!--                                <i class="fas fa-bell text-white"></i>-->
                <!--                                <span class="notification-badge" id="notificationBadge">0</span>-->
                <!--                            </button>-->
                <!--                        </div>-->
                <!--                        <div class="user-avatar" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#profileModal">-->
                <!--                            <span th:text="${#strings.substring(session.userEmail,0,1).toUpperCase()}">U</span>-->
                <!--                        </div>-->
                <!--                        <div class="user-info-container">-->
                <!--                            <p class="user-name" th:text="${session.userEmail}">email@example.com</p>-->
                <!--                            <p class="user-role" th:text="${session.isAdmin ? 'Administrateur' : 'Enseignant'}">Rôle</p>-->
                <!--                        </div>-->
                <!--                        <div class="user-info-container">-->
                <!--                            <p class="user-name">Chargement...</p>-->
                <!--                            <p class="user-role" th:text="${session.isAdmin ? 'Administrateur' : 'Enseignant'}">Rôle</p>-->
                <!--                        </div>-->

                <!--                        <a href="/administrateurs/logout" class="btn btn-action btn-logout">-->
                <!--                            <i class="fas fa-sign-out-alt"></i>-->
                <!--                        </a>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="dashboard-header">
        <h1 class="h3 mb-3" th:text="${session.isAdmin ? 'Tableau de bord administrateur' : 'Mon emploi du temps'}">
            Tableau de bord
        </h1>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" data-stat="totalSeances">0</div>
                <div class="stat-label">Nombre de Séances</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" data-stat="totalHeures">0</div>
                <div class="stat-label">Total Heures de cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" data-stat="totalMatieres">0</div>
                <div class="stat-label">Matières différentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" data-stat="totalSalles">0</div>
                <div class="stat-label">Total de Salles utilisées</div>
            </div>
        </div>


    </div>
    <!-- Nouvelle section pour les disponibilités -->
    <div class="dashboard-header mb-4" th:classappend="${session.isAdmin ? 'd-none' : ''}" id="disponibiliteSection" style="display: none;">
        <h2 class="h4 mb-4">Mes Disponibilités</h2>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Sélectionnez vos jours de disponibilité</h5>
                        <form id="disponibiliteForm" class="row g-3">
                            <div class="col" th:each="jour : ${T(org.univ.projet_tutore.teachPlanner.model.Disponibilite.JourSemaine).values()}">
                                <input type="checkbox" th:id="${jour}" th:value="${jour}"
                                       class="jour-checkbox" name="jours">
                                <label th:for="${jour}" class="jour-label w-100"
                                       th:text="${#strings.capitalize(#strings.toLowerCase(jour))}">
                                    Jour
                                </label>
                            </div>
                            <div class="col-12 text-center mt-4">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i>Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="filters-container" th:classappend="${!session.isAdmin ? 'd-none' : ''}">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="filterEnseignant" class="form-label">
                    <i class="fas fa-user-tie me-2"></i>Filtrer par enseignant
                </label>
                <select id="filterEnseignant" class="form-select">
                    <option value="">Tous les enseignants</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="filterSalle" class="form-label">
                    <i class="fas fa-door-open me-2"></i>Filtrer par salle
                </label>
                <select id="filterSalle" class="form-select">
                    <option value="">Toutes les salles</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="filterMatiere" class="form-label">
                    <i class="fas fa-book me-2"></i>Filtrer par matière
                </label>
                <select id="filterMatiere" class="form-select">
                    <option value="">Toutes les matières</option>
                </select>
            </div>
        </div>
    </div>
    <div id="alertContainer"></div>

    <div id="calendar"></div>
</div>



<!-- Modal d'ajout/modification de séance -->
<div class="modal fade" id="seanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-calendar-plus me-2"></i>Ajouter une Séance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="seanceForm" class="row g-3">
                    <div class="col-md-6">
                        <label for="date" class="form-label">
                            <i class="fas fa-calendar me-2"></i>Date
                        </label>
                        <input type="date" id="date" name="date" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="heureDebut" class="form-label">
                            <i class="fas fa-clock me-2"></i>Heure de début
                        </label>
                        <input type="time"
                               id="heureDebut"
                               name="heureDebut"
                               class="form-control"
                               required
                               min="08:00"
                               max="19:00"
                               step="300">
                        <small class="form-text text-muted">Les cours commencent entre 8h et 19h</small>
                    </div>

                    <div class="col-md-6">
                        <label for="heureFin" class="form-label">
                            <i class="fas fa-clock me-2"></i>Heure de fin
                        </label>
                        <input type="time"
                               id="heureFin"
                               name="heureFin"
                               class="form-control"
                               required
                               min="09:00"
                               max="20:00"
                               step="300">
                        <small class="form-text text-muted">Les cours finissent entre 9h et 20h</small>
                    </div>

                    <!-- Ajouter le conteneur pour les messages de validation -->
                    <div class="col-12">
                        <div id="timeValidationMessage" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="numeroEns" class="form-label">
                            <i class="fas fa-user-tie me-2"></i>Enseignant
                        </label>
                        <div class="combobox-container">
                            <input type="text" id="numeroEns" name="numeroEns" class="combobox-input"
                                   placeholder="Rechercher un enseignant" autocomplete="off" required>
                            <div id="numeroEnsDropdown" class="combobox-dropdown"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="numeroSalle" class="form-label">
                            <i class="fas fa-door-open me-2"></i>Salle
                        </label>
                        <div class="combobox-container">
                            <input type="text" id="numeroSalle" name="numeroSalle" class="combobox-input"
                                   placeholder="Rechercher une salle" autocomplete="off" required>
                            <div id="numeroSalleDropdown" class="combobox-dropdown"></div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="codeMatiere" class="form-label">
                            <i class="fas fa-book me-2"></i>Matière
                        </label>
                        <div class="combobox-container">
                            <input type="text" id="codeMatiere" name="codeMatiere" class="combobox-input"
                                   placeholder="Rechercher une matière" autocomplete="off" required>
                            <div id="codeMatiereDropdown" class="combobox-dropdown"></div>
                        </div>
                        <div class="col-md-12">
                            <label for="groupes" class="form-label">
                                <i class="fas fa-users me-2"></i>Groupes
                            </label>
                            <div class="combobox-container">
                                <select id="groupes" name="groupes" class="form-select" multiple required>
                                    <!-- Les groupes seront chargés dynamiquement -->
                                </select>
                            </div>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-modal" id="remove">
                    <i class="fas fa-trash-alt me-2"></i>Supprimer
                </button>
                <button type="button" class="btn btn-secondary btn-modal" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Annuler
                </button>
                <button type="button" class="btn btn-success btn-modal" id="saveSeance">
                    <i class="fas fa-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/fr.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script th:inline="javascript">
    let notifications = [];

    function updateDashboardStats() {
        fetch('/api/dashboard-stats')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des statistiques');
                }
                return response.json();
            })
            .then(stats => {
                console.log('Statistiques reçues:', stats); // Pour le débogage
                Object.entries(stats).forEach(([key, value]) => {
                    const element = document.querySelector(`[data-stat="${key}"]`);
                    if (element) {
                        element.textContent = value;
                        element.classList.add('stats-update-animation');
                        setTimeout(() => element.classList.remove('stats-update-animation'), 500);
                    }
                });
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour des statistiques:', error);
            });
    }

    function addNotification(message, type = 'info') {
        notifications.push({
            id: Date.now(),
            message,
            type,
            read: false,
            timestamp: new Date()
        });
        updateNotificationBadge();
        updateNotificationList();
    }

    function updateNotificationBadge() {
        const unreadCount = notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notificationBadge');
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'block' : 'none';
    }


    function updateNotificationList() {
        const list = document.querySelector('.notification-list');
        list.innerHTML = notifications.length > 0 ? notifications.map(n => `
            <div class="notification-item ${n.read ? 'read' : ''}" data-id="${n.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="notification-message">${n.message}</div>
                        <small class="text-muted">${new Date(n.timestamp).toLocaleString()}</small>

                    </div>
                    ${!n.read ? '<span class="badge bg-primary">Nouveau</span>' : ''}
                </div>
            </div>
        `).join('') : '<div class="p-3 text-center text-muted">Aucune notification</div>';
    }


    document.addEventListener('DOMContentLoaded', function() {
        // Récupération des variables de session Thymeleaf
        const isAdmin = /*[[${session.isAdmin}]]*/ false;
        const userId = /*[[${session.userId}]]*/ null;
        const userEmail = /*[[${session.userEmail}]]*/ '';
        const heureDebut = document.getElementById('heureDebut');
        const heureFin = document.getElementById('heureFin');
        const validationMessage = document.getElementById('timeValidationMessage');
        const lastConnexion = /*[[${session.lastConnexion}]]*/ '';
        const saveButton = document.getElementById('saveSeance');

        // Fonction pour afficher des alertes
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
            alertContainer.appendChild(alert);

            // Auto-dismiss après 5 secondes
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        }
        // Arrondir au 5 minutes près
        function roundToNearest5(time) {
            const [hours, minutes] = time.split(':');
            const totalMinutes = parseInt(hours) * 60 + parseInt(minutes);
            const roundedMinutes = Math.round(totalMinutes / 5) * 5;
            const newHours = Math.floor(roundedMinutes / 60);
            const newMinutes = roundedMinutes % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
        }
        // Gestionnaire pour l'impression
        const printButton = document.getElementById('printButton');
        if (printButton) {
            printButton.addEventListener('click', function() {
                // Mettre à jour la date et l'année dans les éléments d'impression
                const dateHeader = document.getElementById('printDateHeader');
                const yearFooter = document.getElementById('printYearFooter');

                if (dateHeader) {
                    dateHeader.textContent = `Généré le ${new Date().toLocaleDateString()} à ${new Date().toLocaleTimeString()}`;
                }

                if (yearFooter) {
                    yearFooter.textContent = new Date().getFullYear();
                }

                // Déclencher l'impression
                window.print();
            });
        }

        function validateTimeSelection() {
            const debut = heureDebut.value;
            const fin = heureFin.value;
            let isValid = true;
            let message = '';

            const debutMinutes = timeToMinutes(debut);
            const finMinutes = timeToMinutes(fin);

            // Validation des heures de cours
            if (debutMinutes < timeToMinutes('08:00') || finMinutes > timeToMinutes('20:00')) {
                message = 'Les cours doivent se dérouler entre 8h et 20h';
                isValid = false;
            }
            // Durée minimale (30 minutes)
            else if ((finMinutes - debutMinutes) < 30) {
                message = 'La durée minimale d\'un cours est de 30 minutes';
                isValid = false;
            }
            // Durée maximale (4 heures)
            else if ((finMinutes - debutMinutes) > 240) {
                message = 'La durée maximale d\'un cours est de 4 heures';
                isValid = false;
            }

            validationMessage.textContent = message;
            validationMessage.classList.toggle('d-none', isValid);
            saveButton.disabled = !isValid;

            return isValid;
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':');
            return parseInt(hours) * 60 + parseInt(minutes);
        }

        heureDebut.addEventListener('change', function() {
            this.value = roundToNearest5(this.value);
            validateTimeSelection();
        });

        heureFin.addEventListener('change', function() {
            this.value = roundToNearest5(this.value);
            validateTimeSelection();
        });

        // Valeurs par défaut à l'ouverture du modal
        document.getElementById('seanceModal').addEventListener('show.bs.modal', function() {
            const now = new Date();
            const currentHour = now.getHours();
            const roundedMinutes = Math.round(now.getMinutes() / 5) * 5;

            if (currentHour < 19) {
                const defaultStart = `${String(currentHour + 1).padStart(2, '0')}:${String(roundedMinutes).padStart(2, '0')}`;
                const defaultEnd = `${String(currentHour + 2).padStart(2, '0')}:${String(roundedMinutes).padStart(2, '0')}`;

                heureDebut.value = defaultStart;
                heureFin.value = defaultEnd;
            } else {
                heureDebut.value = '08:00';
                heureFin.value = '09:00';
            }

            validateTimeSelection();
        });

        const calendarEl = document.getElementById('calendar');
        const modal = new bootstrap.Modal(document.getElementById('seanceModal'));
        let currentSeance = null;
        let calendar = null;
        let allSeances = [];

        // Définition des couleurs pour les matières
        const couleursMatieres = {
            "Mathematique": "#ff5733",
            "Physique": "#33ff57",
            "Informatique": "#3357ff",
            "Chimie": "#ff33a6",
            "Anglais": "#a633ff",
            "Histoire": "#ffbb33",
            "Géographie": "#33ffbb"
        };
        document.getElementById("voirdispos").addEventListener("click", function(event) {
            event.preventDefault(); // Empêche le lien de rediriger
            let form = document.getElementById("disponibiliteSection");
            form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
        });

        // Initialiser le calendrier
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'fr',
            firstDay: 1,
            weekNumbers: true,
            weekText: 'S',
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            height: 'auto',
            expandRows: true,
            stickyHeaderDates: true,
            nowIndicator: true,
            editable: isAdmin,
            selectable: isAdmin,
            selectMirror: true,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5],
                startTime: '08:00',
                endTime: '20:00',
            },
            selectConstraint: {
                daysOfWeek: [1, 2, 3, 4, 5]
            },
            dateClick: function(info) {
                if (!isAdmin) return;

                const clickedDate = new Date(info.date);
                const dayOfWeek = clickedDate.getDay();

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    // alert('Les séances ne peuvent pas être créées le weekend');
                    showAlert('Les séances ne peuvent pas être créées le weekend', 'danger');
                    return;
                }

                currentSeance = null;
                document.getElementById('seanceForm').reset();
                document.getElementById('date').value = info.dateStr.split('T')[0];
                document.getElementById('heureDebut').value = info.dateStr.split('T')[1].slice(0, 5);

                const heureFin = new Date(clickedDate.getTime() + 60 * 60 * 1000);
                document.getElementById('heureFin').value = heureFin.toTimeString().slice(0, 5);

                document.getElementById('modalTitle').textContent = 'Ajouter une Séance';
                document.getElementById('remove').style.display = 'none';

                loadAllSelects().then(() => {
                    modal.show();
                });
            },

            // Dans la fonction eventClick, ajout de la sélection des groupes
            eventClick: function(info) {
                if (!isAdmin) return;

                currentSeance = info.event;
                document.getElementById('modalTitle').textContent = 'Modifier la Séance';
                document.getElementById('date').value = info.event.startStr.split('T')[0];
                document.getElementById('heureDebut').value = info.event.startStr.split('T')[1].slice(0, 5);
                document.getElementById('heureFin').value = info.event.endStr.split('T')[1].slice(0, 5);

                loadAllSelects().then(() => {
                    const form = document.getElementById('seanceForm');

                    // Stockage des valeurs originales
                    form.setAttribute('data-original-numero-ens', info.event.extendedProps.numeroEns);
                    form.setAttribute('data-original-numero-salle', info.event.extendedProps.numeroSalle);
                    form.setAttribute('data-original-code-matiere', info.event.extendedProps.codeMatiere);
                    form.setAttribute('data-original-date', info.event.startStr.split('T')[0]);
                    form.setAttribute('data-original-heure-debut', info.event.startStr.split('T')[1].slice(0, 5));
                    form.setAttribute('data-original-heure-fin', info.event.endStr.split('T')[1].slice(0, 5));

                    // Définir les valeurs dans les combobox
                    window.comboboxEns.setValue(info.event.extendedProps.numeroEns);
                    window.comboboxSalle.setValue(info.event.extendedProps.numeroSalle);
                    window.comboboxMatiere.setValue(info.event.extendedProps.codeMatiere);

                    // Mettre à jour les champs de texte
                    document.getElementById('numeroEns').value = info.event.extendedProps.nomEnseignant;
                    document.getElementById('numeroSalle').value = info.event.extendedProps.nomSalle;
                    document.getElementById('codeMatiere').value = info.event.extendedProps.nomMatiere;

                    // Sélectionner les groupes
                    const groupesSelect = document.getElementById('groupes');
                    if (info.event.extendedProps.groupes) {
                        const groupeIds = info.event.extendedProps.groupes.map(g => g.id);
                        Array.from(groupesSelect.options).forEach(option => {
                            option.selected = groupeIds.includes(parseInt(option.value));
                        });
                    }

                    document.getElementById('remove').style.display = 'block';
                    modal.show();
                });
            },

            eventDrop: function(info) {
                if (!isAdmin) {
                    info.revert();
                    return;
                }

                const droppedDate = info.event.start;
                const dayOfWeek = droppedDate.getDay();

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    showAlert('Les séances ne peuvent pas être déplacées au weekend');
                    info.revert();
                    return;
                }

                const seance = {
                    date: info.event.startStr.split('T')[0],
                    heureDebut: info.event.startStr.split('T')[1].slice(0, 5),
                    heureFin: info.event.endStr.split('T')[1].slice(0, 5),
                    numeroEns: info.event.extendedProps.numeroEns,
                    numeroSalle: info.event.extendedProps.numeroSalle,
                    codeMatiere: info.event.extendedProps.codeMatiere
                };

                updateSeance(info.event.id, seance).catch(error => {
                    console.error('Erreur lors de la mise à jour:', error);
                    info.revert();
                });
            }
        });

        calendar.render();

        // Configuration des écouteurs d'événements
        setupEventListeners();
        loadSeances();

        function setupEventListeners() {
            document.getElementById('remove').addEventListener('click', function(e) {
                e.preventDefault();
                if (!currentSeance || !currentSeance.id) return;

                if (confirm('Êtes-vous sûr de vouloir supprimer cette séance ?')) {
                    deleteSeance(currentSeance.id)
                        .then(() => {
                            modal.hide();
                            loadSeances();
                        })
                        .catch(error => {
                            console.error('Erreur lors de la suppression:', error);
                            showAlert('Erreur lors de la suppression de la séance');
                        });
                }
            });

            // document.getElementById('saveSeance').addEventListener('click', function() {
            //     const formData = new FormData(document.getElementById('seanceForm'));
            //     const date = formData.get('date');
            //     const dayOfWeek = new Date(date).getDay();
            //
            //     if (dayOfWeek === 0 || dayOfWeek === 6) {
            //         alert('Les séances ne peuvent pas être créées le weekend');
            //         return;
            //     }
            //
            //     if (formData.get('heureDebut') >= formData.get('heureFin')) {
            //         alert("L'heure de début ne peut pas être supérieure ou égale à l'heure de fin");
            //         return;
            //     }
            //
            //     const seance = {
            //         date: formData.get('date'),
            //         heureDebut: formData.get('heureDebut'),
            //         heureFin: formData.get('heureFin'),
            //         numeroEns: parseInt(formData.get('numeroEns')),
            //         numeroSalle: parseInt(formData.get('numeroSalle')),
            //         codeMatiere: parseInt(formData.get('codeMatiere'))
            //     };
            //
            //     const promise = currentSeance
            //         ? updateSeance(currentSeance.id, seance)
            //         : createSeance(seance);
            //
            //     promise
            //         .then(() => {
            //             modal.hide();
            //             loadSeances();
            //         })
            //         .catch(error => {
            //             console.error('Erreur:', error);
            //             alert('Erreur lors de l\'opération');
            //         });
            // });


            // Gestionnaires des filtres
            document.getElementById('filterEnseignant').addEventListener('change', applyFilters);
            document.getElementById('filterSalle').addEventListener('change', applyFilters);
            document.getElementById('filterMatiere').addEventListener('change', applyFilters);
        }

        function loadSeances() {
            fetch('/api/seances')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(response.status === 401 ? 'Non autorisé' : 'Erreur serveur');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Données reçues:', data); // Pour le débogage

                    // Mise à jour du nom de l'utilisateur
                    if (data.nomComplet) {
                        const userNameElements = document.querySelectorAll('.user-name');
                        userNameElements.forEach(element => {
                            element.textContent = data.nomComplet;
                        });

                        // Mise à jour du nom dans le modal de profil
                        const profileNameElement = document.querySelector('.profile-name');
                        if (profileNameElement) {
                            profileNameElement.textContent = data.nomComplet;
                        }

                        // Mise à jour de l'avatar
                        const avatarElements = document.querySelectorAll('.user-avatar span');
                        avatarElements.forEach(element => {
                            element.textContent = data.nomComplet.charAt(0).toUpperCase();
                        });
                    }

                    // Traitement des séances
                    if (data.seances) {
                        allSeances = data.seances;
                        updateFiltersOptions(data.seances);
                        displaySeances(data.seances);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    const calendar = document.getElementById('calendar');
                    if (calendar) {
                        calendar.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Erreur de chargement</h4>
                        <p>${error.message}</p>
                        <hr>
                        <p class="mb-0">Veuillez réessayer plus tard ou contacter l'administrateur.</p>
                    </div>
                `;
                    }
                });
        }
        function loadEnseignants() {
            return fetch('/api/enseignants')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération des enseignants');
                    }
                    return response.json();
                })
                .then(enseignants => {
                    const select = document.getElementById('numeroEns');
                    select.innerHTML = '<option value="">Sélectionner un enseignant</option>';
                    enseignants.forEach(enseignant => {
                        const option = document.createElement('option');
                        option.value = enseignant.numero_ens;
                        option.textContent = enseignant.nom_complet;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    addNotification('Erreur lors du chargement des enseignants', 'error');
                });
        }

        function loadSalles() {
            return fetch('/api/salles')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération des salles');
                    }
                    return response.json();
                })
                .then(salles => {
                    const select = document.getElementById('numeroSalle');
                    select.innerHTML = '<option value="">Sélectionner une salle</option>';
                    salles.forEach(salle => {
                        const option = document.createElement('option');
                        option.value = salle.numero_salle;
                        option.textContent = salle.nom_salle;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    addNotification('Erreur lors du chargement des salles', 'error');
                });
        }

        function loadMatieres() {
            return fetch('/api/matieres')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération des matières');
                    }
                    return response.json();
                })
                .then(matieres => {
                    const select = document.getElementById('codeMatiere');
                    select.innerHTML = '<option value="">Sélectionner une matière</option>';
                    matieres.forEach(matiere => {
                        const option = document.createElement('option');
                        option.value = matiere.code_matiere;
                        option.textContent = matiere.nom_matiere;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    addNotification('Erreur lors du chargement des matières', 'error');
                });
        }


        function createCombobox(inputId, dropdownId, data, displayKey, valueKey) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            let selectedValue = '';
            let items = [];

            function filterItems(query) {
                return data.filter(item =>
                    item[displayKey].toLowerCase().includes(query.toLowerCase())
                );
            }

            function updateDropdown(filteredItems) {
                dropdown.innerHTML = '';
                items = filteredItems;

                filteredItems.forEach((item, index) => {
                    const option = document.createElement('div');
                    option.className = 'combobox-option';
                    option.textContent = item[displayKey];
                    if(item[valueKey] === selectedValue) {
                        option.classList.add('selected');
                    }

                    option.addEventListener('click', () => {
                        input.value = item[displayKey];
                        selectedValue = item[valueKey];
                        input.dataset.value = selectedValue;
                        dropdown.classList.remove('show');
                    });

                    dropdown.appendChild(option);
                });
            }

            input.addEventListener('focus', () => {
                updateDropdown(data);
                dropdown.classList.add('show');
            });

            input.addEventListener('input', () => {
                const filteredItems = filterItems(input.value);
                updateDropdown(filteredItems);
                dropdown.classList.add('show');
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Pour définir une valeur programmatiquement
            return {
                setValue: (value) => {
                    const item = data.find(i => i[valueKey] === value);
                    if (item) {
                        input.value = item[displayKey];
                        selectedValue = item[valueKey];
                        input.dataset.value = selectedValue;
                    }
                },
                getValue: () => selectedValue
            };
        }

// Dans la fonction loadAllSelects, modifiez le code pour utiliser les combobox :
        // Modification de la fonction loadAllSelects pour inclure les groupes
        function loadAllSelects() {
            return Promise.all([
                fetch('/api/seance/enseignants').then(r => r.json()),
                fetch('/api/salles').then(r => r.json()),
                fetch('/api/matieres').then(r => r.json()),
                fetch('/api/groupes/api').then(r => r.json())
            ]).then(([enseignants, salles, matieres, groupes]) => {
                window.comboboxEns = createCombobox(
                    'numeroEns',
                    'numeroEnsDropdown',
                    enseignants,
                    'nom_complet',
                    'numero_ens'
                );

                window.comboboxSalle = createCombobox(
                    'numeroSalle',
                    'numeroSalleDropdown',
                    salles,
                    'nom_salle',
                    'numero_salle'
                );

                window.comboboxMatiere = createCombobox(
                    'codeMatiere',
                    'codeMatiereDropdown',
                    matieres,
                    'nom_matiere',
                    'code_matiere'
                );

                // Mise à jour du select des groupes
                const groupesSelect = document.getElementById('groupes');
                groupesSelect.innerHTML = '';
                groupes.forEach(groupe => {
                    const option = document.createElement('option');
                    option.value = groupe.id;
                    option.textContent = `${groupe.nom} (${groupe.anneeScolaire})`;
                    groupesSelect.appendChild(option);
                });
            });
        }



        function updateUserProfile(nomComplet) {
            // Mettre à jour le nom dans l'avatar
            const avatarSpan = document.querySelector('.user-avatar span');
            if (avatarSpan && nomComplet) {
                avatarSpan.textContent = nomComplet.charAt(0).toUpperCase();
            }

            // Mettre à jour le nom dans le modal de profil
            const profileName = document.querySelector('.profile-name');
            if (profileName) {
                profileName.textContent = nomComplet || 'Utilisateur';
            }
        }


        function updateFiltersOptions(seances) {
            const enseignants = new Set();
            const salles = new Set();
            const matieres = new Set();

            seances.forEach(seance => {
                if (seance.nomEnseignant) enseignants.add(seance.nomEnseignant);
                if (seance.nomSalle) salles.add(seance.nomSalle);
                if (seance.nomMatiere) matieres.add(seance.nomMatiere);
            });

            updateSelectOptions('filterEnseignant', enseignants);
            updateSelectOptions('filterSalle', salles);
            updateSelectOptions('filterMatiere', matieres);
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;

            select.innerHTML = '<option value="">Tous</option>';
            Array.from(options).sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            if (Array.from(options).includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function applyFilters() {
            const enseignantFilter = document.getElementById('filterEnseignant').value;
            const salleFilter = document.getElementById('filterSalle').value;
            const matiereFilter = document.getElementById('filterMatiere').value;

            const filteredSeances = allSeances.filter(seance => {
                return (!enseignantFilter || seance.nomEnseignant === enseignantFilter) &&
                    (!salleFilter || seance.nomSalle === salleFilter) &&
                    (!matiereFilter || seance.nomMatiere === matiereFilter);
            });

            displaySeances(filteredSeances);
        }

        // Modification de la fonction displaySeances pour inclure les groupes
        function displaySeances(seances) {
            calendar.removeAllEvents();
            seances.forEach(seance => {
                const groupesInfo = seance.groupes ?
                    '\nGroupes: ' + seance.groupes.map(g => g.nom).join(', ') : '';

                calendar.addEvent({
                    id: seance.idSeance,
                    title: `${seance.nomMatiere}\n${seance.nomEnseignant}\nSalle: ${seance.nomSalle}${groupesInfo}`,
                    start: `${seance.date}T${seance.heureDebut}`,
                    end: `${seance.date}T${seance.heureFin}`,
                    backgroundColor: getEventColor(seance.nomMatiere),
                    extendedProps: {
                        numeroEns: seance.numeroEns,
                        numeroSalle: seance.numeroSalle,
                        codeMatiere: seance.codeMatiere,
                        nomEnseignant: seance.nomEnseignant,
                        nomMatiere: seance.nomMatiere,
                        nomSalle: seance.nomSalle,
                        groupes: seance.groupes
                    }
                });
            });
        }

        function getEventColor(matiere) {
            return couleursMatieres[matiere] || "#808080";
        }
        // Dans la fonction createSeance du fichier JavaScript
        function loadGroupes() {
            return fetch('/api/groupes/api')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération des groupes');
                    }
                    return response.json();
                })
                .then(groupes => {
                    const select = document.getElementById('groupes');
                    select.innerHTML = '';
                    groupes.forEach(groupe => {
                        const option = document.createElement('option');
                        option.value = groupe.id;
                        option.textContent = `${groupe.nom} (${groupe.anneeScolaire})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    addNotification('Erreur lors du chargement des groupes', 'error');
                });
        }

// Modification de la fonction createSeance pour inclure les groupes
        function createSeance(seance) {
            return fetch('/api/seances', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(seance)
            }).then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        throw new Error('Session expirée');
                    }
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erreur lors de la création de la séance');
                    });
                }
                return response.json();
            });
        }

// Modification de la fonction updateSeance pour inclure les groupes
        function updateSeance(id, seance) {
            const selectedGroupes = Array.from(document.getElementById('groupes').selectedOptions)
                .map(option => parseInt(option.value));

            seance.groupeIds = selectedGroupes;

            return fetch(`/api/seances/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(seance)
            }).then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Erreur lors de la mise à jour de la séance');
                    });
                }
                return response.json();
            });
        }

// Mettre à jour le gestionnaire d'événements pour le bouton de sauvegarde
        document.getElementById('saveSeance').addEventListener('click', function() {
            const form = document.getElementById('seanceForm');
            const formData = new FormData(form);

            // Vérification si des modifications ont été apportées
            const hasChanges =
                formData.get('date') !== form.getAttribute('data-original-date') ||
                formData.get('heureDebut') !== form.getAttribute('data-original-heure-debut') ||
                formData.get('heureFin') !== form.getAttribute('data-original-heure-fin') ||
                formData.get('numeroEns') !== form.getAttribute('data-original-numero-ens') ||
                formData.get('numeroSalle') !== form.getAttribute('data-original-numero-salle') ||
                formData.get('codeMatiere') !== form.getAttribute('data-original-code-matiere');

            if (!hasChanges && currentSeance) {
                modal.hide();
                return;
            }

            const date = formData.get('date');
            const dayOfWeek = new Date(date).getDay();

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                alert('Les séances ne peuvent pas être créées le weekend');
                return;
            }

            if (formData.get('heureDebut') >= formData.get('heureFin')) {
                alert("L'heure de début ne peut pas être supérieure ou égale à l'heure de fin");
                return;
            }


            const seance = {
                date: formData.get('date'),
                heureDebut: formData.get('heureDebut'),
                heureFin: formData.get('heureFin'),
                numeroEns: parseInt(document.getElementById('numeroEns').dataset.value),
                numeroSalle: parseInt(document.getElementById('numeroSalle').dataset.value),
                codeMatiere: parseInt(document.getElementById('codeMatiere').dataset.value),
                groupeIds: Array.from(document.getElementById('groupes').selectedOptions)
                    .map(option => parseInt(option.value))
            };

            const promise = currentSeance
                ? updateSeance(currentSeance.id, seance)
                : createSeance(seance);

            promise
                .then(() => {
                    modal.hide();
                    loadSeances();
                    addNotification('Séance enregistrée avec succès', 'success');
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    try {
                        const errorObj = JSON.parse(error.message);
                        alert(errorObj.error || 'Une erreur est survenue');
                    } catch (e) {
                        alert(error.message || 'Une erreur est survenue');
                    }
                });
        });


        // function createSeance(seance) {
        //     return fetch('/api/seances', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify(seance)
        //     }).then(response => {
        //         if (!response.ok) throw new Error('Erreur lors de la création de la séance');
        //         return response.json();
        //     });
        // }
        //
        // function updateSeance(id, seance) {
        //     return fetch(`/api/seances/${id}`, {
        //         method: 'PUT',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify(seance)
        //     }).then(response => {
        //         if (!response.ok) throw new Error('Erreur lors de la mise à jour de la séance');
        //         return response.json();
        //     });
        // }

        function deleteSeance(id) {
            return fetch(`/api/seances/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (!response.ok) throw new Error('Erreur lors de la suppression de la séance');
            });
        }


        updateDashboardStats();
        setInterval(updateDashboardStats, 300000);


        // Mise à jour périodique des statistiques (toutes les 5 minutes)
        setInterval(updateDashboardStats, 300000);

        // Gestionnaire du bouton de notifications
        const notificationButton = document.getElementById('notificationButton');
        const notificationDropdown = document.getElementById('notificationDropdown');

        notificationButton.addEventListener('click', function(e) {
            e.stopPropagation();
            notificationDropdown.classList.toggle('show');
            // Marquer toutes les notifications comme lues
            markNotificationsAsRead();
        });

        function markNotificationsAsRead() {
            notifications.forEach(notification => notification.read = true);
            updateNotificationBadge();
            updateNotificationList();
        }

        // Fermer le dropdown au clic en dehors
        document.addEventListener('click', function(e) {
            if (!notificationDropdown.contains(e.target) && !notificationButton.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });
        if (!/*[[${session.isAdmin}]]*/ false) {
            // D'abord récupérer le numéro d'enseignant à partir de l'ID du personnel
            fetch('/api/enseignants/me')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors de la récupération des informations de l\'enseignant');
                    }
                    return response.json();
                })
                .then(enseignant => {
                    const numeroEns = enseignant.numero_ens;
                    if (!numeroEns) {
                        throw new Error('Numéro d\'enseignant non trouvé');
                    }

                    // Stocker le numéro d'enseignant pour une utilisation ultérieure
                    window.numeroEnseignant = numeroEns;

                    // Charger les disponibilités initiales
                    loadDisponibilites(numeroEns);

                    // Configurer le gestionnaire d'événements du formulaire
                    document.getElementById('disponibiliteForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        const checkboxes = document.querySelectorAll('input[name="jours"]:checked');
                        const jours = Array.from(checkboxes).map(cb => cb.value);

                        // Mettre à jour les disponibilités avec le numéro d'enseignant correct
                        updateDisponibilites(numeroEns, jours);
                    });
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    addNotification('Erreur lors de la récupération des informations de l\'enseignant', 'error');
                });

            function updateDisponibilites(numeroEns, jours) {
                // Supprimer les disponibilités existantes
                fetch(`/api/disponibilites/enseignant/${numeroEns}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(disponibilites => {
                        if (!Array.isArray(disponibilites)) {
                            disponibilites = [];
                        }

                        // Supprimer toutes les disponibilités existantes
                        const deletePromises = disponibilites.map(dispo =>
                            fetch(`/api/disponibilites/enseignant/${numeroEns}/jour/${dispo.jour}`, {
                                method: 'DELETE'
                            }).then(response => {
                                if (!response.ok) {
                                    throw new Error(`Erreur lors de la suppression: ${response.status}`);
                                }
                            })
                        );

                        return Promise.all(deletePromises);
                    })
                    .then(() => {
                        // Créer les nouvelles disponibilités
                        const createPromises = jours.map(jour =>
                            fetch('/api/disponibilites', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    numeroEns: numeroEns,
                                    jour: jour
                                })
                            }).then(response => {
                                if (!response.ok) {
                                    throw new Error(`Erreur lors de la création: ${response.status}`);
                                }
                                return response.json();
                            })
                        );

                        return Promise.all(createPromises);
                    })
                    .then(() => {
                        addNotification('Disponibilités mises à jour avec succès', 'success');
                        // ✅ Réafficher la section après mise à jour
                        document.getElementById("disponibiliteSection").style.display = "none";
                        loadDisponibilites(numeroEns);
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        addNotification(`Erreur lors de la mise à jour des disponibilités: ${error.message}`, 'error');
                    });
            }

            function loadDisponibilites(numeroEns) {
                fetch(`/api/disponibilites/enseignant/${numeroEns}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(disponibilites => {
                        if (!Array.isArray(disponibilites)) {
                            disponibilites = [];
                        }

                        // Mettre à jour les cases à cocher
                        document.querySelectorAll('input[name="jours"]').forEach(checkbox => {
                            checkbox.checked = disponibilites.some(d => d.jour === checkbox.value);
                        });
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des disponibilités:', error);
                        addNotification(`Erreur lors du chargement des disponibilités: ${error.message}`, 'error');
                    });
            }
        }


        // Exemple de notification
        setTimeout(() => {
            addNotification('Bienvenue dans votre emploi du temps !', 'info');
        }, 2000);
    });
</script>
<script>
    // Gestionnaire du menu de profil
    document.getElementById('profileTrigger').addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('show');
    });

    // Fermer le menu au clic en dehors
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('profileDropdown');
        if (!dropdown.contains(e.target) && !e.target.closest('#profileTrigger')) {
            dropdown.classList.remove('show');
        }
    });

    // Gestionnaire du thème
    let isDarkMode = false;
    document.getElementById('themeToggle').addEventListener('click', function() {
        isDarkMode = !isDarkMode;
        document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
        this.innerHTML = isDarkMode ?
            '<i class="fas fa-sun"></i> Thème clair' :
            '<i class="fas fa-moon"></i> Thème sombre';
    });

    // Animation de l'avatar
    const avatar = document.querySelector('.profile-avatar');
    avatar.addEventListener('mouseover', function() {
        this.style.transform = 'scale(1.05) rotate(5deg)';
    });
    avatar.addEventListener('mouseout', function() {
        this.style.transform = 'scale(1) rotate(0deg)';
    });
</script>
</body>
</html>